<!DOCTYPE html>

<html
  lang="ko" xmlns:th="http://www.thymeleaf.org"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
>
<th:block th:replace="~{layout/mainlayout::all(~{this::#head} ,~{this::#content})}">

  <span id="head">
    <title>타이틀</title>
    <!--Style-->
    <style>
      .modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
          background-color: rgb(0,0,0);
          background-color: rgba(0,0,0,0.4);
          padding-top: 60px;
      }
      .modal-content {
          background-color: #fefefe;
          margin: 5% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
      }
      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }
      .close:hover,
      .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
      }
      .button-container {
          display: flex;
          justify-content: space-around;
          margin-top: 20px;
      }
      #content1 {
        height: 350px;
        overflow-y: auto; /* 내부 스크롤 활성화 */
      }
      #content2 {
        height: 350px;
        overflow-y: auto; /* 내부 스크롤 활성화 */
      }
    </style>
    <!--/Style-->
  </span>

  <span id="content">
    <div class="container-xxl flex-grow-1 container-p-y">
      <div class="row">
        <!-- First column -->
        <div class="col-lg-3 mb-4">
          <!-- Card 1 -->
          <div class="card h-100">
            <div class="card-body text-center">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="dropdown">
                  <!-- Dropdown content here -->
                </div>
              </div>
              <i class="menu-icon tf-icons bx bx-cube-alt"></i>
              <h3 class="card-title text-nowrap mb-1">
                <a th:href="@{/production/list_newProduct}">신규 제품 자재</a>
              </h3>
              <span class="fw-semibold d-block mb-1">확인 필요</span>
              <small class="text-success fw-semibold" style="font-size: 2.2em;"><i class="bx bx-up-arrow-alt"></i> [[${newProductCount}]]</small>
            </div>
          </div>
        </div>
        <!-- Second column -->
        <div class="col-lg-3 mb-4">
          <!-- Card 2 -->
          <div class="card h-100">
            <div class="card-body text-center">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="dropdown">
                  <!-- Dropdown content here -->
                </div>
              </div>
              <i class="menu-icon tf-icons bx bx-cube-alt"></i>
              <h3 class="card-title text-nowrap mb-1">
                <a th:href="@{/jodal/list_jodal}">신규 조달 계획</a>
              </h3>
              <span class="fw-semibold d-block mb-1">등록 필요</span>
              <small class="text-success fw-semibold" style="font-size: 2.2em;"><i class="bx bx-up-arrow-alt"></i> [[${newNoneChasu}]]</small>
            </div>
          </div>
        </div>
        <!-- Fourth column -->
        <div class="col-lg-3 mb-4">
          <!-- Card 4 -->
          <div class="card h-100">
            <div class="card-body text-center">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="dropdown">
                  <!-- Dropdown content here -->
                </div>
              </div>
              <i class="bx bx-buildings"></i>
              <h3 class="card-title text-nowrap mb-1">
                <a th:href="@{/goodshandling/list_received}">신규 입고</a>
              </h3>
              <span class="fw-semibold d-block mb-1">확인 필요</span>
              <small class="text-success fw-semibold" style="font-size: 2.2em;"><i class="bx bx-up-arrow-alt"></i> [[${newShipment}]]</small>
            </div>
          </div>
        </div>
        <!-- Third column -->
        <div class="col-lg-3 mb-4">
          <!-- Card 3 -->
          <div class="card h-100">
            <div class="card-body text-center">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="dropdown">
                  <!-- Dropdown content here -->
                </div>
              </div>
              <i class="menu-icon tf-icons bx bx-cube-alt"></i>
              <h3 class="card-title text-nowrap mb-1">
                <a th:href="@{/goodshandling/list_request}">신규 출하</a>
              </h3>
              <span class="fw-semibold d-block mb-1">확인 필요</span>
              <small class="text-success fw-semibold" style="font-size: 2.2em;"><i class="bx bx-up-arrow-alt"></i> [[${newRequest}]]</small>
            </div>
          </div>
        </div>
      </div>
      <!-- first row end -->
      <!-- Total Revenue -->
      <div class="row justify-content-center">
        <!-- Existing Card -->
        <!-- Card 5 -->
        <div class="col-lg-12 col-md-6 mb-4">
          <!-- Card 6 -->
          <div class="card" style="height: 446px;">
            <div class="card-body">
              <div class="mb-2"><strong>입고 관리</strong></div>
                <div class="table-responsive text-nowrap">
                  <div id="content1">
                    <table class="table table-bordered mb-2">
                      <thead>
                        <tr>
                          <th>
                            <select class="form-select form-select-sm" style="width: fit-content;" id="baljuProductName">
                              <option value="">전체 제품</option>
                              <option th:each="list:${baljuProductList}" th:value="${list.manuCode}">[[${list.name}]]</option>
                            </select>
                          </th>
                          <th>자재번호</th>
                          <th>자재명</th>
                          <th>협력 업체</th>
                          <th>협력 업체에서 보낸 수량</th>
                          <th>확인</th>
                        </tr>
                      </thead>
                      <tbody class="table-border-bottom-0" id="firstTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <!-- Add navigation links here -->
          </div>
        </div>
        <!--/Card-->
        <div class="col-lg-12 col-md-6 mb-4">
          <!-- Card 6 -->
          <div class="card" style="height: 446px;">
          <div class="card-body">
            <div class="mb-2"><strong>긴급 납품 지시</strong></div>
               <div class="btn-group">
                   <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        수량 순
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0);" onclick="fetchEmergencyDeliveryRequests('high')">수량 높은순</a></li>
                        <li><a class="dropdown-item" href="javascript:void(0);" onclick="fetchEmergencyDeliveryRequests('low')">수량 낮은순</a></li>
                    </ul>
                </div>
             <div class="btn-group">
                    <!-- 검수일 정렬 드롭다운 -->
                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        검수일 순
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="javascript:void(0);" onclick="fetchEmergencyDeliveryRequests('early')">검수일 빠른순</a></li>
                        <li><a class="dropdown-item" href="javascript:void(0);" onclick="fetchEmergencyDeliveryRequests('late')">검수일 늦은순</a></li>
                    </ul>
                </div>
                <table id="emergency-requests-table" class="table table-bordered mb-2">
                    <thead>
                        <tr>
                            <th>제품</th>
                            <th>자재</th>
                          <th>부족 수량</th>
                            <th>검수일</th>
                            <th>요청</th>
                        </tr>
                    </thead>
                    <tbody id="emergency-table-body">
                        <!-- JavaScript로 데이터를 여기에 동적으로 삽입합니다. -->


                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- New Card -->
        <!--/Card-->
      </div>
    </div>

    <!--Modal-->
    <div class="modal fade" id="modalCenter" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalCenterTitle">입고처리</h5>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col mb-3 text-center">
                [긴급]부족 수량 :  <span id="shortageAmount"></span>개
              </div>
            </div>
            <div class="row g-2">
              <div class="col mb-0">
                <label for="emailWithTitle" class="form-label">담당자</label>
                <input
                        type="text"
                        id="emailWithTitle"
                        class="form-control"
                        placeholder="실명 입력"
                /> <label class="form-label">납품 받을 날짜 입력</label>
                <input  id="deliveryDate"
                        type="date"

                        class="form-control"
                />
              </div>
              <div class="col mb-0">
                <label  class="form-label">납품지시 수량 입력</label>
                <input
                        id="deliveryQuantity"
                        type="number"
                        class="form-control"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
    <input type="hidden" id="requestIdInput"> <!-- 숨겨진 입력 필드 추가 -->
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              취소
            </button>
            <button type="button" class="btn btn-primary" id="deliveryConfirmButton" >납품 지시</button>
          </div>
        </div>
      </div>
    </div>
    <!--Modal2-->
    <div class="modal fade" id="modalCenter2" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">수령확인</h5>
          </div>
          <div class="modal-body">
            <div class="col mb-3 text-center" id="receiveText"></div>
          </div>
          <div class="modal-footer">
            <form th:action="@{/goodshandling/receiveCheck}" method="post">
              <input style="display:none;" name="shipNO" id="receiveNo">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                취소
              </button>
              <button type="submit" class="btn btn-primary">수령확인</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!--/Modal2-->


    <!--/Modal-->

    <!--Script-->
    <script>
      let page = 1;
      let finPage=false;
      let baljuProductName = null;

      let page2 = 1;
      let finPage2=false;

      document.getElementById('baljuProductName').addEventListener("change", function(){
        baljuProductName=document.getElementById('baljuProductName').value;
        page = 1;
        finPage=false;
        document.getElementById("firstTbody").innerText='';
        loadItems();
      });

      function loadItems() {
        const content1 = document.getElementById("content1");
        const firstTbody = document.getElementById("firstTbody");

        baljuProductName=(document.getElementById("baljuProductName").value!='')?document.getElementById("baljuProductName").value:null;

        $.ajax({
          url:'/list/nonReciveShipment',
          method:'GET',
          data:{page:page, baljuProductName:baljuProductName},
          success:function(data){
            if(data.totalPage<page) finPage=true;

            data.dtoList.forEach(x=>{
              const productName=x.shipmentDTO.baljuDTO.contractDTO.jodalPlanDTO.proplanDTO.productDTO.name;
              const materCode=x.shipmentDTO.baljuDTO.contractDTO.jodalPlanDTO.materialDTO.materCode;
              const materialName=x.shipmentDTO.baljuDTO.contractDTO.jodalPlanDTO.materialDTO.name;
              const partnerName=x.shipmentDTO.baljuDTO.contractDTO.partnerDTO.name;
              const shipNum=x.shipmentDTO.shipNum;
              const shipNO=x.shipmentDTO.shipNO;

              const newRow = document.createElement("tr");

              [productName, materCode, materialName, partnerName, shipNum].forEach(text => {
                const item = document.createElement("td");
                item.textContent = text;
                newRow.appendChild(item);
              });

              const btnTd = document.createElement("td");
              btnTd.innerHTML=`
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCenter2" shipNum="${shipNum}" shipNo="${shipNO}" onclick="receivebutton(this)">
                  수령
                </button>
              `;
              newRow.appendChild(btnTd);

              firstTbody.appendChild(newRow);
            });
          }
        });

        page++;
      }



      document.addEventListener("DOMContentLoaded", function () {
        content1.addEventListener("scroll", function () {
          if(finPage==false){
            const scrollTop = content1.scrollTop;
            const scrollHeight = content1.scrollHeight;
            const clientHeight = content1.clientHeight;

            if (scrollTop + clientHeight >= scrollHeight - 10) {
              loadItems();
            }
          }
        });


        loadItems();

      });
    </script>
    <script>
      function receivebutton(button){
        var shipNum=button.getAttribute('shipNum');
        var shipNo=button.getAttribute('shipNo');
        document.getElementById('receiveText').innerHTML="협력회사에서 보낸 수량은 "+shipNum+"개 입니다.<br/>수령확정시 '수령확인'버튼을 누르세요.";
        document.getElementById('receiveNo').value=shipNo;
      }
    </script>

    <script>
  // Function to show the modal with the updated shortage amount
function showOptions(shortage) {
  // Set the shortage amount in the modal
  document.getElementById('shortageAmount').textContent = shortage || 0;
  document.getElementById('deliveryQuantity').value = shortage || 0;

  // Show the modal
  var myModal = new bootstrap.Modal(document.getElementById('modalCenter'), {
    keyboard: false
  });
  myModal.show();
}

// Event listener for the request button
document.addEventListener('DOMContentLoaded', function () {
  fetchEmergencyDeliveryRequests('high'); // 기본적으로 수량 높은순으로 정렬하여 데이터 로드

  // Attach click event to request buttons
  document.getElementById('emergency-table-body').addEventListener('click', function (event) {
    if (event.target && event.target.matches('button.request-btn')) {
      var shortage = event.target.getAttribute('data-shortage'); // Get shortage value from button attribute
      showOptions(shortage); // Show modal with shortage value
    }
  });

  // Attach click event to the delivery confirmation button
  document.getElementById('deliveryConfirmButton').addEventListener('click', function () {
    // Collect input values from the modal
    const emerNum = document.getElementById('deliveryQuantity').value;
    const emerDate = document.querySelector('input[type="date"]').value;
    const who = document.getElementById('emailWithTitle').value;

    // Convert date format to LocalDateTime compatible string
    const emerDateTime = emerDate ? emerDate + 'T00:00:00' : null; // YYYY-MM-DDT00:00:00 format

    // Create DTO object
    const emergencyDTO = {
      emerNum: emerNum,
      emerDate: emerDateTime,
      who: who,
      emcheck: 0 // Default value 0
    };

    // Send data to the server
    fetch('/order/createEmergency', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(emergencyDTO)
    })
      .then(response => response.json())
      .then(data => {
        if (data) {
          alert('납품 지시가 성공적으로 저장되었습니다.');
          location.reload(); // Reload the page to update the list or table
        } else {
          alert('납품 지시 저장에 실패했습니다.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('납품 지시 저장 중 오류가 발생했습니다.');
      });
  });
});

// Function to fetch emergency delivery requests and update the table
function fetchEmergencyDeliveryRequests(orderBy) {
  fetch('/proteam/login/emergency-delivery-requests?orderBy=' + orderBy)
    .then(response => response.json())
    .then(data => {
      updateEmergencyTable(data);
    })
    .catch(error => {
      console.error('Error fetching emergency delivery requests:', error);
    });
}

// Function to update the table with fetched data
function updateEmergencyTable(data) {
  var tableBody = document.getElementById('emergency-table-body');
  tableBody.innerHTML = ''; // Clear existing table content

  data.forEach(function (item) {
    var shortage = 0; // Initialize shortage to 0

    // Extract shortage amount from the text if available
    if (item.text && item.text.includes('부족')) {
      var matches = item.text.match(/\d+/); // Extract number from text
      if (matches) {
        shortage = parseInt(matches[0], 10); // Convert to integer
      }
    }

    var row = `<tr>

                  <td>${item.proplanDTO ? item.proplanDTO.productDTO.name : ''}</td>
                  <td><strong>${item.materialDTO ? item.materialDTO.name : ''}</strong></td>
                  <td>${shortage || 0}</td> <!-- Show shortage amount -->
                  <td>${item.eventDate || ''}</td>
                  <td><button type="button" class="btn btn-primary request-btn" data-shortage="${shortage}">요청</button></td>
              </tr>`;
    tableBody.insertAdjacentHTML('beforeend', row);
  });
}

    </script>




    <!--Script-->
  </span>

</th:block>
</html>